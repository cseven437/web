<!doctype html><html><title>linux进程间通信-信号量</title><meta name=description content="定义 信号量本质上是一个计数器（不设置全局变量是因为进程间是相互独立的，而这不一定能看到，看到也不能保证++引用计数为原子操作）,用于多进程对共享数据对象的读取，它和管道有所不同，它不以传送数据为主要目的，它主要是用来保护共享资源（信号量也属于临界资源），使得资源在一个时刻只有一个进程独享。
"><meta name=generator content="Hugo 0.88.1">
<meta property="og:title" content="linux进程间通信-信号量">
<meta property="og:description" content="定义
信号量本质上是一个计数器（不设置全局变量是因为进程间是相互独立的，而这不一定能看到，看到也不能保证++引用计数为原子操作）,用于多进程对共享数据对象的读取，它和管道有所不同，它不以传送数据为主要目的，它主要是用来保护共享资源（信号量也属于临界资源），使得资源在一个时刻只有一个进程独享。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://arair.net/posts/f35cdf32/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-03-14T10:41:11+08:00">
<meta property="article:modified_time" content="2021-03-14T10:41:11+08:00">
<meta itemprop=name content="linux进程间通信-信号量">
<meta itemprop=description content="定义
信号量本质上是一个计数器（不设置全局变量是因为进程间是相互独立的，而这不一定能看到，看到也不能保证++引用计数为原子操作）,用于多进程对共享数据对象的读取，它和管道有所不同，它不以传送数据为主要目的，它主要是用来保护共享资源（信号量也属于临界资源），使得资源在一个时刻只有一个进程独享。"><meta itemprop=datePublished content="2021-03-14T10:41:11+08:00">
<meta itemprop=dateModified content="2021-03-14T10:41:11+08:00">
<meta itemprop=wordCount content="3406">
<meta itemprop=keywords content="linux进程间通信,">
<style type=text/css>body{background-color:#fff;color:#000}@media(prefers-color-scheme:dark){body{background-color:#0d1117;color:#c9d1d9}:any-link{color:#58a6ff}}</style><body><div id=content>
<body>
<div id=post class=post>
<article>
<header>
<h1 class=post-title>linux进程间通信-信号量</h1>
<p>
<small>
2021-03-14
</small>
</p>
</header>
<aside>
<nav id=TableOfContents>
<ul>
<li><a href=#定义>定义</a></li>
<li><a href=#信号量的工作原理>信号量的工作原理</a></li>
<li><a href=#二元信号量>二元信号量</a></li>
<li><a href=#进程如何获得共享资源>进程如何获得共享资源</a></li>
<li><a href=#与信号量相关的函数>与信号量相关的函数</a></li>
<li><a href=#兼容系统v的信号量的函数>兼容系统v的信号量的函数</a>
<ul>
<li><a href=#semget>semget</a></li>
<li><a href=#semctl>semctl</a></li>
<li><a href=#semop>semop</a></li>
</ul>
</li>
<li><a href=#posix信号量函数>posix信号量函数</a>
<ul>
<li><a href=#sem_init>sem_init</a></li>
<li><a href=#sem_post>sem_post</a></li>
<li><a href=#sem_wait>sem_wait</a></li>
<li><a href=#sem_destroy>sem_destroy</a></li>
</ul>
</li>
<li><a href=#例子>例子</a></li>
</ul>
</nav>
</aside>
<h2 id=定义>定义</h2>
<p>信号量本质上是一个计数器（不设置全局变量是因为进程间是相互独立的，而这不一定能看到，看到也不能保证<code>++</code>引用计数为原子操作）,用于多进程对共享数据对象的读取，它和管道有所不同，它不以传送数据为主要目的，它主要是用来保护共享资源（信号量也属于临界资源），使得资源在一个时刻只有一个进程独享。</p>
<h2 id=信号量的工作原理>信号量的工作原理</h2>
<p>由于信号量只能进行两种操作等待和发送信号，即<code>P(sv)</code>和<code>V(sv)</code>edg,他们的行为是这样的：</p>
<ol>
<li>P(sv)：如果sv的值大于零，就给它减1；如果它的值为零，就挂起该进程的执行</li>
<li>V(sv)：如果有其他进程因等待sv而被挂起，就让它恢复运行，如果没有进程因等待sv而挂起，就给它加1.</li>
</ol>
<p>在信号量进行PV操作时都为原子操作（因为它需要保护临界资源）</p>
<p>注：原子操作：单指令的操作称为原子的，单条指令的执行是不会被打断的</p>
<h2 id=二元信号量>二元信号量</h2>
<p>二元信号量（Binary Semaphore）是最简单的一种锁（互斥锁），它只用两种状态：占用与非占用。所以它的引用计数为1。</p>
<h2 id=进程如何获得共享资源>进程如何获得共享资源</h2>
<ol>
<li>测试控制该资源的信号量</li>
<li>信号量的值为正，进程获得该资源的使用权，进程将信号量减1，表示它使用了一个资源单位</li>
<li>若此时信号量的值为0，则进程进入挂起状态（进程状态改变），直到信号量的值大于0，若进程被唤醒则返回至第一步。</li>
</ol>
<p>注：信号量通过同步与互斥保证访问资源的一致性。</p>
<h2 id=与信号量相关的函数>与信号量相关的函数</h2>
<ul>
<li>sem_init 是posix信号量，进程退出会自动释放</li>
<li>semget 是兼容系统v的信号量，必须明确对其进行删除操作才会释放</li>
</ul>
<p>通常使用posix信号量函数比较多</p>
<h2 id=兼容系统v的信号量的函数>兼容系统v的信号量的函数</h2>
<h3 id=semget>semget</h3>
<p>创建信号量</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/ipc.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/sem.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>semget</span>(key_t key, <span style=color:#66d9ef>int</span> nsems, <span style=color:#66d9ef>int</span> semflg);

<span style=color:#75715e>#define key_t int
</span></code></pre></td></tr></table>
</div>
</div><p>参数:</p>
<ul>
<li>key: 建立IPC通讯(消息队列，信号量和共享内存)时必须指定一个ID值。通常情况下，该id值通过ftok函数得到，由内核变成标识符，要想让两个进程看到同一个信号集，只需设置key值不变就可以。</li>
<li>nsems: 指定信号量集中需要大的信号量数目，通常为1</li>
<li>semflg: 一组标志，当想要当信号量不存在时创建一个新的信号量，可以将flag设置为IPC_CREAT与文件权限按位或操作
<blockquote>
<p>设置了IPC_CREAT标志后，即使给出的key是一个已有信号量的key，也不会产生错误。而IPC_CREAT | IPC_EXCL则可以创建一个新的，唯一的信号量，如果信号量已存在，返回一个错误。一般我们会还或上一个文件权限</p>
</blockquote>
</li>
</ul>
<h3 id=semctl>semctl</h3>
<p>删除和初始化信号量</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/ipc.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/sem.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>semctl</span>(<span style=color:#66d9ef>int</span> semid, <span style=color:#66d9ef>int</span> semnum, <span style=color:#66d9ef>int</span> cmd, ...);
</code></pre></td></tr></table>
</div>
</div><p>参数:</p>
<ul>
<li>
<p>semid: 由<code>semget</code>返回的信号量标识符</p>
</li>
<li>
<p>semnum: 当前信号量集的哪一个信号量</p>
</li>
<li>
<p>cmd: 通常下面两个值中大的其中一个</p>
<ul>
<li>SETVAL: 用来把信号量初始化为一个已知的值。p 这个值通过union semun中的val成员设置，其作用是在信号量第一次使用前对它进行设置。</li>
<li>IPC_RMID: 用于删除一个已经无需继续使用的信号量标识符，删除的话就不需要缺省参数，只需要三个参数即可</li>
</ul>
<p>如有需要第四个参数一般设置为union semnu arg</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>union</span> semun {
    <span style=color:#66d9ef>int</span>              val;    <span style=color:#75715e>/* Value for SETVAL */</span>
    <span style=color:#66d9ef>struct</span> semid_ds <span style=color:#f92672>*</span>buf;    <span style=color:#75715e>/* Buffer for IPC_STAT, IPC_SET */</span>
    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span>  <span style=color:#f92672>*</span>array;  <span style=color:#75715e>/* Array for GETALL, SETALL */</span>
    <span style=color:#66d9ef>struct</span> seminfo  <span style=color:#f92672>*</span>__buf;  <span style=color:#75715e>/* Buffer for IPC_INFO
</span><span style=color:#75715e>                                (Linux-specific) */</span>
};
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id=semop>semop</h3>
<p>改变信号量大的值</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/types.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/ipc.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/sem.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>semop</span>(<span style=color:#66d9ef>int</span> semid, <span style=color:#66d9ef>struct</span> sembuf <span style=color:#f92672>*</span>sops, size_t nsops);

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>semtimedop</span>(<span style=color:#66d9ef>int</span> semid, <span style=color:#66d9ef>struct</span> sembuf <span style=color:#f92672>*</span>sops, size_t nsops,
               <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> timespec <span style=color:#f92672>*</span>timeout);
</code></pre></td></tr></table>
</div>
</div><p>参数:</p>
<ul>
<li>nsops: 进行操作信号量的个数，即sops结构变量的个数，需大于或等于1。最常见设置此值等于1，只完成对一个信号量的操作</li>
<li>sembuf:
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>struct</span> sembuf{ 
    <span style=color:#66d9ef>short</span> sem_num;   <span style=color:#75715e>//除非使用一组信号量，否则它为0 
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>short</span> sem_op;   <span style=color:#75715e>//信号量在一次操作中需要改变的数据，通常是两个数，                                        
</span><span style=color:#75715e></span>                    <span style=color:#75715e>//一个是-1，即P（等待）操作， 
</span><span style=color:#75715e></span>                    <span style=color:#75715e>//一个是+1，即V（发送信号）操作。 
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>short</span> sem_flg; <span style=color:#75715e>//通常为SEM_UNDO,使操作系统跟踪信号量， 
</span><span style=color:#75715e></span>                <span style=color:#75715e>//并在进程没有释放该信号量而终止时，操作系统释放信号量 
</span><span style=color:#75715e></span>}; 
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>通常设置为SEM_UNDO,使操作系统跟踪信号量， 并在进程没有释放该信号量而终止时，操作系统释放信号量 ，例如在二元信号量中，你不释放该信号量 而异常退出，就会导致别的进程一直申请不到信号量，而一直处于挂起状态。</p>
<h2 id=posix信号量函数>posix信号量函数</h2>
<h3 id=sem_init>sem_init</h3>
<p>该函数用于创建信号量，其原型如下</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;semaphore.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sem_init</span>(sem_t <span style=color:#f92672>*</span>sem, <span style=color:#66d9ef>int</span> pshared, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> value);

Link with <span style=color:#f92672>-</span>pthread.
</code></pre></td></tr></table>
</div>
</div><p>该函数初始化由sem指向的信号对象，设置它的共享选项，并给它一个初始的整数值。</p>
<ul>
<li>pshared: 控制信号量的类型，如果其值为0，就表示这个信号量是当前进程的局部信号量，否则信号量就可以在多个进程之间共享，</li>
<li>value: 为sem的初始值。</li>
</ul>
<p>返回值</p>
<ul>
<li>成功时返回0</li>
<li>失败返回-1.</li>
</ul>
<h3 id=sem_post>sem_post</h3>
<p>释放信号量，让信号量的值加1。相当于V操作。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;semaphore.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sem_post</span>(sem_t <span style=color:#f92672>*</span>sem);

Link with <span style=color:#f92672>-</span>pthread.
</code></pre></td></tr></table>
</div>
</div><p>返回值:</p>
<ul>
<li>成功: 返回0</li>
<li>失败: 返回-1</li>
</ul>
<h3 id=sem_wait>sem_wait</h3>
<p>等待信号量，如果信号量的值大于0,将信号量的值减1,立即返回。如果信号量的值为0,则线程阻塞，相当于P操作。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sem_wait</span>(sem_t <span style=color:#f92672>*</span>sem);  
</code></pre></td></tr></table>
</div>
</div><p>成功返回0,失败返回-1。</p>
<h3 id=sem_destroy>sem_destroy</h3>
<p>该函数用于对用完的信号量的清理。它的原型如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sem_destroy</span>(sem_t <span style=color:#f92672>*</span>sem); 
</code></pre></td></tr></table>
</div>
</div><p>成功时返回0，失败时返回-1.</p>
<h2 id=例子>例子</h2>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;semaphore.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;pthread.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define total 20
</span><span style=color:#75715e></span>
sem_t remain, apple, pear, mutex;
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> vremain <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, vapple <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, vpear <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>father</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mather</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>son</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>daughter</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print_sem</span>();

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
{  
    pthread_t fa, ma, so, da;  
    sem_init(<span style=color:#f92672>&amp;</span>remain, <span style=color:#ae81ff>0</span>, total);<span style=color:#75715e>//总数初始化为20 
</span><span style=color:#75715e></span>    sem_init(<span style=color:#f92672>&amp;</span>apple, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);<span style=color:#75715e>//盆子中苹果数, 开始为0  
</span><span style=color:#75715e></span>    sem_init(<span style=color:#f92672>&amp;</span>pear, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);<span style=color:#75715e>//盆子中梨子数, 开始为0   
</span><span style=color:#75715e></span>    sem_init(<span style=color:#f92672>&amp;</span>mutex, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>);<span style=color:#75715e>//互斥锁, 初始为1 
</span><span style=color:#75715e></span>    pthread_create(<span style=color:#f92672>&amp;</span>fa, NULL, <span style=color:#f92672>&amp;</span>father, NULL);  
    pthread_create(<span style=color:#f92672>&amp;</span>ma, NULL, <span style=color:#f92672>&amp;</span>mather, NULL);  
    pthread_create(<span style=color:#f92672>&amp;</span>so, NULL, <span style=color:#f92672>&amp;</span>son, NULL); 
    pthread_create(<span style=color:#f92672>&amp;</span>da, NULL, <span style=color:#f92672>&amp;</span>daughter, NULL);    
    <span style=color:#66d9ef>for</span>(;;);
}
<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>father</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg)
{  
    <span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>)
    {      
        sem_wait(<span style=color:#f92672>&amp;</span>remain);     
        sem_wait(<span style=color:#f92672>&amp;</span>mutex);      
        printf(<span style=color:#e6db74>&#34;父亲: 放苹果之前, 剩余空间=%u, 苹果数=%u</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, vremain<span style=color:#f92672>--</span>, vapple<span style=color:#f92672>++</span>);
        printf(<span style=color:#e6db74>&#34;父亲: 放苹果之后, 剩余空间=%u, 苹果数=%u</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, vremain, vapple);
        sem_post(<span style=color:#f92672>&amp;</span>mutex);      
        sem_post(<span style=color:#f92672>&amp;</span>apple);  
        sleep(<span style=color:#ae81ff>1</span>);  
    }
}
<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mather</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg)
{  
    <span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>)
    {      
        sem_wait(<span style=color:#f92672>&amp;</span>remain);     
        sem_wait(<span style=color:#f92672>&amp;</span>mutex);      
        printf(<span style=color:#e6db74>&#34;母亲: 放梨子之前, 剩余空间=%u, 梨子数=%u</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, vremain<span style=color:#f92672>--</span>, vpear<span style=color:#f92672>++</span>);
        printf(<span style=color:#e6db74>&#34;母亲: 放梨子之后, 剩余空间=%u, 梨子数=%u</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, vremain, vpear);
        sem_post(<span style=color:#f92672>&amp;</span>mutex);  
        sem_post(<span style=color:#f92672>&amp;</span>pear);   
        sleep(<span style=color:#ae81ff>2</span>);  
    }
}
<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>son</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg)
{  
    <span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>)
    {      
        sem_wait(<span style=color:#f92672>&amp;</span>pear);   
        sem_wait(<span style=color:#f92672>&amp;</span>mutex);   
        printf(<span style=color:#e6db74>&#34;儿子: 吃梨子之前, 剩余空间=%u, 梨子数=%u</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, vremain<span style=color:#f92672>++</span>, vpear<span style=color:#f92672>--</span>);
        printf(<span style=color:#e6db74>&#34;儿子: 吃梨子之后, 剩余空间=%u, 梨子数=%u</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, vremain, vpear);
        sem_post(<span style=color:#f92672>&amp;</span>mutex);  
        sem_post(<span style=color:#f92672>&amp;</span>remain);     
        sleep(<span style=color:#ae81ff>3</span>);
    }
}
<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>daughter</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg)
{  
    <span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>)
    {  
        sem_wait(<span style=color:#f92672>&amp;</span>apple);  
        sem_wait(<span style=color:#f92672>&amp;</span>mutex);
        printf(<span style=color:#e6db74>&#34;女儿: 吃苹果之前, 剩余空间=%u, 苹果数=%u</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, vremain<span style=color:#f92672>++</span>, vapple<span style=color:#f92672>--</span>);
        printf(<span style=color:#e6db74>&#34;女儿: 吃苹果之前, 剩余空间=%u, 苹果数=%u</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, vremain, vapple);   
        sem_post(<span style=color:#f92672>&amp;</span>mutex);  
        sem_post(<span style=color:#f92672>&amp;</span>remain); 
        sleep(<span style=color:#ae81ff>3</span>);  
    }
}
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print_sem</span>()
{  
    <span style=color:#66d9ef>int</span> val1, val2, val3;
    sem_getvalue(<span style=color:#f92672>&amp;</span>remain, <span style=color:#f92672>&amp;</span>val1);  
    sem_getvalue(<span style=color:#f92672>&amp;</span>apple, <span style=color:#f92672>&amp;</span>val2);   
    sem_getvalue(<span style=color:#f92672>&amp;</span>pear, <span style=color:#f92672>&amp;</span>val3);
    printf(<span style=color:#e6db74>&#34;Semaphore: remain:%d, apple:%d, pear:%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, val1, val2, val3);
}
</code></pre></td></tr></table>
</div>
</div><p>运行结果</p>
<pre tabindex=0><code>母亲: 放梨子之前, 剩余空间=20, 梨子数=0
母亲: 放梨子之后, 剩余空间=19, 梨子数=1
儿子: 吃梨子之前, 剩余空间=19, 梨子数=1
儿子: 吃梨子之后, 剩余空间=20, 梨子数=0
父亲: 放苹果之前, 剩余空间=20, 苹果数=0
父亲: 放苹果之后, 剩余空间=19, 苹果数=1
女儿: 吃苹果之前, 剩余空间=19, 苹果数=1
女儿: 吃苹果之前, 剩余空间=20, 苹果数=0
父亲: 放苹果之前, 剩余空间=20, 苹果数=0
父亲: 放苹果之后, 剩余空间=19, 苹果数=1
母亲: 放梨子之前, 剩余空间=19, 梨子数=0
母亲: 放梨子之后, 剩余空间=18, 梨子数=1
父亲: 放苹果之前, 剩余空间=18, 苹果数=1
父亲: 放苹果之后, 剩余空间=17, 苹果数=2
儿子: 吃梨子之前, 剩余空间=17, 梨子数=1
儿子: 吃梨子之后, 剩余空间=18, 梨子数=0
女儿: 吃苹果之前, 剩余空间=18, 苹果数=2
女儿: 吃苹果之前, 剩余空间=19, 苹果数=1
父亲: 放苹果之前, 剩余空间=19, 苹果数=1
父亲: 放苹果之后, 剩余空间=18, 苹果数=2
母亲: 放梨子之前, 剩余空间=18, 梨子数=0
母亲: 放梨子之后, 剩余空间=17, 梨子数=1
父亲: 放苹果之前, 剩余空间=17, 苹果数=2
父亲: 放苹果之后, 剩余空间=16, 苹果数=3
父亲: 放苹果之前, 剩余空间=16, 苹果数=3
父亲: 放苹果之后, 剩余空间=15, 苹果数=4
儿子: 吃梨子之前, 剩余空间=15, 梨子数=1
儿子: 吃梨子之后, 剩余空间=16, 梨子数=0
女儿: 吃苹果之前, 剩余空间=16, 苹果数=4
女儿: 吃苹果之前, 剩余空间=17, 苹果数=3
母亲: 放梨子之前, 剩余空间=17, 梨子数=0
母亲: 放梨子之后, 剩余空间=16, 梨子数=1
父亲: 放苹果之前, 剩余空间=16, 苹果数=3
父亲: 放苹果之后, 剩余空间=15, 苹果数=4
父亲: 放苹果之前, 剩余空间=15, 苹果数=4
父亲: 放苹果之后, 剩余空间=14, 苹果数=5
</code></pre><p>原文:https://www.cnblogs.com/wuyepeng/p/9748552.html</p>
</article>
</div>
</body>
<div>
<small> words: 3406 tags:</small>
<small><code><a href=https://arair.net/tags/linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1>linux进程间通信</a></code></small>
</div>
</html>
</div>
<script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?bd28dafb59c7621d0ab721cefd01691b",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script>
<script id=LA_COLLECT src=//sdk.51.la/js-sdk-pro.min.js></script>
<script>LA.init({id:"JMTlKgP6j8mqnJSa",ck:"JMTlKgP6j8mqnJSa"})</script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>window.onload=function(){mermaid.initialize({theme:"default"}),mermaid.init(void 0,".language-mermaid")}</script></body>
</html>