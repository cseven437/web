<!doctype html><html><title>linux进程间通信--共享内存</title><meta name=description content="共享内存 共享内存是System V版本的最后一个进程间通信方式。共享内存，顾名思义就是允许两个不相关的进程访问同一个逻辑内存，共享内存是两个正在运行的进程之间共享和传递数据的一种非常有效的方式。不同进程之间共享的内存通常为同一段物理内存。进程可以将同一段物理内存连接到他们自己的地址空间中，所有的进程都可以访问共享内存中的地址。如果某个进程向共享内存写入数据，所做的改动将立即影响到可以访问同一段共享内存的任何其他进程。
"><meta name=generator content="Hugo 0.91.0">
<meta property="og:title" content="linux进程间通信--共享内存">
<meta property="og:description" content="共享内存
共享内存是System V版本的最后一个进程间通信方式。共享内存，顾名思义就是允许两个不相关的进程访问同一个逻辑内存，共享内存是两个正在运行的进程之间共享和传递数据的一种非常有效的方式。不同进程之间共享的内存通常为同一段物理内存。进程可以将同一段物理内存连接到他们自己的地址空间中，所有的进程都可以访问共享内存中的地址。如果某个进程向共享内存写入数据，所做的改动将立即影响到可以访问同一段共享内存的任何其他进程。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://arair.net/p/language/c/linux/052f29b2/"><meta property="article:section" content="p">
<meta property="article:published_time" content="2021-03-06T10:41:30+08:00">
<meta property="article:modified_time" content="2021-03-06T10:41:30+08:00">
<meta itemprop=name content="linux进程间通信--共享内存">
<meta itemprop=description content="共享内存
共享内存是System V版本的最后一个进程间通信方式。共享内存，顾名思义就是允许两个不相关的进程访问同一个逻辑内存，共享内存是两个正在运行的进程之间共享和传递数据的一种非常有效的方式。不同进程之间共享的内存通常为同一段物理内存。进程可以将同一段物理内存连接到他们自己的地址空间中，所有的进程都可以访问共享内存中的地址。如果某个进程向共享内存写入数据，所做的改动将立即影响到可以访问同一段共享内存的任何其他进程。"><meta itemprop=datePublished content="2021-03-06T10:41:30+08:00">
<meta itemprop=dateModified content="2021-03-06T10:41:30+08:00">
<meta itemprop=wordCount content="2045">
<meta itemprop=keywords content="c,linux,">
<style type=text/css>.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media(max-width:767px){.markdown-body{padding:15px}}</style>
<script>function setTheme({el:a=document.documentElement,mode:b='auto',light:c='light',dark:d='dark'}){a.dataset.colorMode=b,a.dataset.lightTheme=c,a.dataset.darkTheme=d}let prefersDarkMode=window.matchMedia('(prefers-color-scheme: dark)').matches;prefersDarkMode&&setTheme({mode:'dark'})</script>
<link rel=stylesheet href=/style.css type=text/css><body id=content class=markdown-body>
<body>
<div id=post class=post>
<article>
<header>
<h1 class=post-title>linux进程间通信--共享内存</h1>
<p>
<small>
2021-03-06
</small>
</p>
</header>
<aside>
<nav id=TableOfContents>
<ul>
<li><a href=#共享内存>共享内存</a></li>
<li><a href=#函数介绍>函数介绍</a>
<ul>
<li><a href=#shmget----用来获得共享内存区域的id>shmget &ndash; 用来获得共享内存区域的ID。</a></li>
<li><a href=#shmat----把共享内存对象映射到调用进程的地址空间>shmat &ndash; 把共享内存对象映射到调用进程的地址空间</a></li>
<li><a href=#shmdt----断开共享内存的连接>shmdt &ndash; 断开共享内存的连接</a></li>
<li><a href=#shmctl----完成对共享内存的控制>shmctl &ndash; 完成对共享内存的控制</a></li>
</ul>
</li>
<li><a href=#示例>示例</a></li>
<li><a href=#总结>总结</a></li>
</ul>
</nav>
</aside>
<h2 id=共享内存>共享内存</h2>
<p>共享内存是System V版本的最后一个进程间通信方式。共享内存，顾名思义就是允许两个不相关的进程访问同一个逻辑内存，共享内存是两个正在运行的进程之间共享和传递数据的一种非常有效的方式。不同进程之间共享的内存通常为同一段物理内存。进程可以将同一段物理内存连接到他们自己的地址空间中，所有的进程都可以访问共享内存中的地址。如果某个进程向共享内存写入数据，所做的改动将立即影响到可以访问同一段共享内存的任何其他进程。</p>
<h2 id=函数介绍>函数介绍</h2>
<p>共享内存相关函数有<code>shmget()</code>,<code>shmat()</code>,<code>shmdt()</code>,<code>shmctl()</code></p>
<h3 id=shmget----用来获得共享内存区域的id>shmget &ndash; 用来获得共享内存区域的ID。</h3>
<p>函数定义</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/shm.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>shmget</span><span class=p>(</span><span class=n>key_t</span> <span class=n>key</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=kt>int</span> <span class=n>shmflg</span><span class=p>);</span>
</code></pre></div><p>参数：</p>
<ul>
<li>key: 提供一个参数key(0-32位整数)，通过key查找或创建对应的共享内存段</li>
<li>size: size以字节为单位指定需要共享大的内存容量</li>
<li>shmflag: 权限标志，需要与IPC对象存取权限(如0600)进行<code>|</code>运算来确定信号量集的存取权限
<ul>
<li>IPC_CREAT: 如果不存在键值与key相等的共享内存，则新建一个共享内存，如果存在这样的共享内存，则返回共享内存的标识符</li>
<li>IPC_EXCL: 与IPC_CREATE配合使用，如果内核中不存在键值与key相等的共享内存，则新建一个共享内存；如果存在这样的共享内存则报错</li>
</ul>
</li>
</ul>
<p>返回值：</p>
<ul>
<li>成功: 返回共享内存的标识符</li>
<li>失败: -1，错误原因存于errno中</li>
</ul>
<p>错误代码：</p>
<ul>
<li>EINVAL：参数size小于SHMMIN或大于SHMMAX</li>
<li>EEXIST：预建立key所指的共享内存，但已经存在</li>
<li>EIDRM：参数key所指的共享内存已经删除</li>
<li>ENOSPC：超过了系统允许建立的共享内存的最大值(SHMALL)</li>
<li>ENOENT：参数key所指的共享内存不存在，而参数shmflg未设IPC_CREAT位</li>
<li>EACCES：没有权限</li>
<li>ENOMEM：核心内存不足</li>
</ul>
<h3 id=shmat----把共享内存对象映射到调用进程的地址空间>shmat &ndash; 把共享内存对象映射到调用进程的地址空间</h3>
<p>函数定义</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/shm.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>void</span> <span class=o>*</span><span class=nf>shmat</span><span class=p>(</span><span class=kt>int</span> <span class=n>shmid</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>shmaddr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>shmflg</span><span class=p>);</span>
</code></pre></div><p>参数：</p>
<ul>
<li>shmid: 共享内存标识符</li>
<li>shmaddr: 指定共享内存出现在进程内存地址的什么位置，直接指定为<code>NULL</code>让内核自己决定一个合适大的地址位置</li>
<li>shmflag: SHM_RDONLY为只读模式，其它为读写模式</li>
</ul>
<p>返回值</p>
<ul>
<li>成功: 附加好的共享内存地址</li>
<li>失败: -1 错误原因存于errno中</li>
</ul>
<p>错误代码：</p>
<ul>
<li>EACCES：没有权限以指定方式连接共享内存</li>
<li>EINVAL：无效的参数shmid或shmaddr</li>
<li>ENOMEM：核心内存不足</li>
</ul>
<h3 id=shmdt----断开共享内存的连接>shmdt &ndash; 断开共享内存的连接</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/shm.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>shmdt</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>shmaddr</span><span class=p>);</span>
</code></pre></div><p>参数： shmaddr: 连接的共享内存的起始地址</p>
<p>返回值：</p>
<ul>
<li>成功: 0</li>
<li>失败: -1</li>
</ul>
<p>errno:</p>
<ul>
<li>EINVAL：无效的参数shmaddr</li>
</ul>
<h3 id=shmctl----完成对共享内存的控制>shmctl &ndash; 完成对共享内存的控制</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/shm.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>shmctl</span><span class=p>(</span><span class=kt>int</span> <span class=n>shmid</span><span class=p>,</span> <span class=kt>int</span> <span class=n>cmd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>shmid_ds</span> <span class=o>*</span><span class=n>buf</span><span class=p>);</span>
</code></pre></div><p>参数</p>
<ul>
<li>shmid: 共享内存标识符</li>
<li>cmd:
<ul>
<li>IPC_STAT: 得到共享内存的状态，把共享内存的shmid_ds结构复制到buf中</li>
<li>IPC_SET: 改变共享内存的状态，把buf所指的shmid_ds结构中的uid、gid、mode复制到共享内存的shmid_ds结构内</li>
<li>IPC_RMID: 删除这片共享内存</li>
</ul>
</li>
<li>buf: 共享内存管理结构体。具体说明参见共享内存内核结构定义部分</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>struct</span> <span class=n>shmid_ds</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=n>ipc_perm</span> <span class=n>shm_perm</span><span class=p>;</span>    <span class=cm>/* Ownership and permissions */</span>
    <span class=n>size_t</span>          <span class=n>shm_segsz</span><span class=p>;</span>   <span class=cm>/* Size of segment (bytes) */</span>
    <span class=n>time_t</span>          <span class=n>shm_atime</span><span class=p>;</span>   <span class=cm>/* Last attach time */</span>
    <span class=n>time_t</span>          <span class=n>shm_dtime</span><span class=p>;</span>   <span class=cm>/* Last detach time */</span>
    <span class=n>time_t</span>          <span class=n>shm_ctime</span><span class=p>;</span>   <span class=cm>/* Last change time */</span>
    <span class=n>pid_t</span>           <span class=n>shm_cpid</span><span class=p>;</span>    <span class=cm>/* PID of creator */</span>
    <span class=n>pid_t</span>           <span class=n>shm_lpid</span><span class=p>;</span>    <span class=cm>/* PID of last shmat(2)/shmdt(2) */</span>
    <span class=n>shmatt_t</span>        <span class=n>shm_nattch</span><span class=p>;</span>  <span class=cm>/* No. of current attaches */</span>
    <span class=p>...</span>
<span class=p>};</span>

<span class=k>struct</span> <span class=n>ipc_perm</span> <span class=p>{</span>
    <span class=n>key_t</span>          <span class=n>__key</span><span class=p>;</span>    <span class=cm>/* Key supplied to shmget(2) */</span>
    <span class=n>uid_t</span>          <span class=n>uid</span><span class=p>;</span>      <span class=cm>/* Effective UID of owner */</span>
    <span class=n>gid_t</span>          <span class=n>gid</span><span class=p>;</span>      <span class=cm>/* Effective GID of owner */</span>
    <span class=n>uid_t</span>          <span class=n>cuid</span><span class=p>;</span>     <span class=cm>/* Effective UID of creator */</span>
    <span class=n>gid_t</span>          <span class=n>cgid</span><span class=p>;</span>     <span class=cm>/* Effective GID of creator */</span>
    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>mode</span><span class=p>;</span>     <span class=cm>/* Permissions + SHM_DEST and
</span><span class=cm>                                SHM_LOCKED flags */</span>
    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>__seq</span><span class=p>;</span>    <span class=cm>/* Sequence number */</span>
<span class=p>};</span>
</code></pre></div><p>返回值：</p>
<ul>
<li>成功: 0</li>
<li>失败: -1</li>
</ul>
<p>errno:</p>
<ul>
<li>EACCES：参数cmd为IPC_STAT，却没有权限读取该共享内存</li>
<li>EFAULT：参数buf指向无效的内存地址</li>
<li>EIDRM：标识符为shmid的共享内存已被删除</li>
<li>EINVAL：无效的参数cmd或shmid</li>
<li>EPERM：参数cmd为IPC_SET或IPC_RMID，却无足够的权限执行</li>
</ul>
<h2 id=示例>示例</h2>
<p>头文件</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// shm.h
</span><span class=c1></span><span class=cp>#ifndef _SHMDATA_H_HEADER
</span><span class=cp>#define _SHMDATA_H_HEADER
</span><span class=cp>#define TEXT_SZ 2048
</span><span class=cp></span><span class=k>struct</span> <span class=n>shared_use_st</span>
<span class=p>{</span>  
    <span class=kt>int</span> <span class=n>written</span><span class=p>;</span><span class=c1>//作为一个标志，非0：表示可读，0表示可写 
</span><span class=c1></span>    <span class=kt>char</span> <span class=n>text</span><span class=p>[</span><span class=n>TEXT_SZ</span><span class=p>];</span><span class=c1>//记录写入和读取的文本
</span><span class=c1></span><span class=p>};</span>
<span class=cp>#endif
</span></code></pre></div><p>write</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/shm.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;shm.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>key_t</span> <span class=n>key</span> <span class=o>=</span> <span class=mi>1234</span><span class=p>;</span>
    <span class=k>struct</span> <span class=n>shared_use_st</span> <span class=o>*</span><span class=n>shared</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>size</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>shmid</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>running</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>shmid</span> <span class=o>=</span> <span class=n>shmget</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>shared_use_st</span><span class=p>),</span> <span class=mo>0666</span><span class=o>|</span><span class=n>IPC_CREAT</span><span class=p>);</span>

    <span class=k>if</span><span class=p>(</span><span class=n>shmid</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>perror</span><span class=p>(</span><span class=s>&#34;shmget&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;memory attached at 0x%X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>shmid</span><span class=p>);</span>

    <span class=n>shared</span> <span class=o>=</span> <span class=n>shmat</span><span class=p>(</span><span class=n>shmid</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>shared</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>perror</span><span class=p>(</span><span class=s>&#34;shmat&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=k>while</span><span class=p>(</span><span class=n>running</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>

            <span class=n>printf</span><span class=p>(</span><span class=s>&#34;wait.....</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
            <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>else</span>
        <span class=p>{</span>
            <span class=n>printf</span><span class=p>(</span><span class=s>&#34;enter buf:&#34;</span><span class=p>);</span>
            <span class=n>fgets</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>text</span><span class=p>,</span> <span class=n>BUFSIZ</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
            <span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
            <span class=k>if</span><span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>text</span><span class=p>,</span> <span class=s>&#34;exit&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>running</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;shadt</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>

    <span class=k>if</span><span class=p>(</span><span class=n>shmdt</span><span class=p>(</span><span class=n>shared</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>perror</span><span class=p>(</span><span class=s>&#34;shmdt&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// printf(&#34;shmctl\n&#34;);
</span><span class=c1></span>    <span class=c1>// if(shmctl(shmid, IPC_RMID, 0) == -1) {
</span><span class=c1></span>    <span class=c1>//     perror(&#34;shmctl&#34;);
</span><span class=c1></span>    <span class=c1>//     return -1;
</span><span class=c1></span>    <span class=c1>// }
</span><span class=c1></span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>read</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;sys/shm.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;shm.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>key_t</span> <span class=n>key</span> <span class=o>=</span> <span class=mi>1234</span><span class=p>;</span>
    <span class=k>struct</span> <span class=n>shared_use_st</span> <span class=o>*</span><span class=n>shared</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>size</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>shmid</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>running</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>shmid</span> <span class=o>=</span> <span class=n>shmget</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>shared_use_st</span><span class=p>),</span> <span class=mo>0666</span><span class=o>|</span><span class=n>IPC_CREAT</span><span class=p>);</span>

    <span class=k>if</span><span class=p>(</span><span class=n>shmid</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>peror</span><span class=p>(</span><span class=s>&#34;shmget&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;memory attached at 0x%X</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>shmid</span><span class=p>);</span>

    <span class=n>shared</span> <span class=o>=</span> <span class=n>shmat</span><span class=p>(</span><span class=n>shmid</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>shared</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>peror</span><span class=p>(</span><span class=s>&#34;shmat&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=k>while</span><span class=p>(</span><span class=n>running</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>

            <span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=n>printf</span><span class=p>(</span><span class=s>&#34;read text:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>shared</span><span class=o>-&gt;</span><span class=n>text</span><span class=p>);</span>
            <span class=k>if</span><span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>text</span><span class=p>,</span> <span class=s>&#34;exit&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>running</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>else</span>
        <span class=p>{</span>
            <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;shadt</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>

    <span class=k>if</span><span class=p>(</span><span class=n>shmdt</span><span class=p>(</span><span class=n>shared</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>perror</span><span class=p>(</span><span class=s>&#34;shmdt&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;shmctl</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>if</span><span class=p>(</span><span class=n>shmctl</span><span class=p>(</span><span class=n>shmid</span><span class=p>,</span> <span class=n>IPC_RMID</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>perror</span><span class=p>(</span><span class=s>&#34;shmctl&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<ol>
<li>
<p>共享内存中的数据，从来不写入到实际磁盘文件中去；而通过mmap()映射普通文件实现的共享内存通信可以指定何时将数据写入磁盘文件中。 注：系统V共享内存机制实际是通过shm文件系统中的文件实现的，shm文件系统的安装点在交换分区上，系统重新引导后，所有的内容都丢失。</p>
</li>
<li>
<p>共享内存是随内核持续的，即使所有访问共享内存的进程都已经正常终止，共享内存区仍然存在（除非显式删除共享内存），在内核重新引导之前，对该共享内存区域的任何改写操作都将一直保留。</p>
</li>
<li>
<p>通过调用mmap()映射普通文件进行进程间通信时，一定要注意考虑进程何时终止对通信的影响。而通过共享内存实现通信的进程则不然。</p>
</li>
</ol>
</article>
</div>
</body>
<div>
<small> words: 2045 tags:</small>
<small><code><a href=https://arair.net/tags/c>c</a></code></small>
<small><code><a href=https://arair.net/tags/linux>linux</a></code></small>
</div>
</html>
</body>
<script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?bd28dafb59c7621d0ab721cefd01691b",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script>
<script id=LA_COLLECT src=//sdk.51.la/js-sdk-pro.min.js></script>
<script>LA.init({id:"JMTlKgP6j8mqnJSa",ck:"JMTlKgP6j8mqnJSa"})</script>
<link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.2.0/build/styles/default.min.css>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.2.0/build/highlight.min.js></script>
<script>hljs.highlightAll()</script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>window.onload=function(){mermaid.initialize({theme:"default"}),mermaid.init(void 0,".language-mermaid")}</script></html>