<!doctype html><html><title>linux进程间通信-信号量</title><meta name=description content="定义 信号量本质上是一个计数器（不设置全局变量是因为进程间是相互独立的，而这不一定能看到，看到也不能保证++引用计数为原子操作）,用于多进程对共享数据对象的读取，它和管道有所不同，它不以传送数据为主要目的，它主要是用来保护共享资源（信号量也属于临界资源），使得资源在一个时刻只有一个进程独享。
"><meta name=generator content="Hugo 0.101.0"><meta property="og:title" content="linux进程间通信-信号量"><meta property="og:description" content="定义
信号量本质上是一个计数器（不设置全局变量是因为进程间是相互独立的，而这不一定能看到，看到也不能保证++引用计数为原子操作）,用于多进程对共享数据对象的读取，它和管道有所不同，它不以传送数据为主要目的，它主要是用来保护共享资源（信号量也属于临界资源），使得资源在一个时刻只有一个进程独享。"><meta property="og:type" content="article"><meta property="og:url" content="https://arair.net/p/language/c/linux/f35cdf32/"><meta property="article:section" content="p"><meta property="article:published_time" content="2021-03-14T10:41:11+08:00"><meta property="article:modified_time" content="2021-03-14T10:41:11+08:00"><meta itemprop=name content="linux进程间通信-信号量"><meta itemprop=description content="定义
信号量本质上是一个计数器（不设置全局变量是因为进程间是相互独立的，而这不一定能看到，看到也不能保证++引用计数为原子操作）,用于多进程对共享数据对象的读取，它和管道有所不同，它不以传送数据为主要目的，它主要是用来保护共享资源（信号量也属于临界资源），使得资源在一个时刻只有一个进程独享。"><meta itemprop=datePublished content="2021-03-14T10:41:11+08:00"><meta itemprop=dateModified content="2021-03-14T10:41:11+08:00"><meta itemprop=wordCount content="3280"><meta itemprop=keywords content="linux进程间通信,"><style type=text/css>.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media(max-width:767px){.markdown-body{padding:15px}}</style><script>function setTheme({el:e=document.documentElement,mode:t="auto",light:n="light",dark:s="dark"}){e.dataset.colorMode=t,e.dataset.lightTheme=n,e.dataset.darkTheme=s}let prefersDarkMode=window.matchMedia("(prefers-color-scheme: dark)").matches;prefersDarkMode&&setTheme({mode:"dark"})</script><link rel=stylesheet href=/style.css type=text/css><body id=content class=markdown-body><body><div id=post class=post><article><header><h1 class=post-title>linux进程间通信-信号量</h1><p><small>2021-03-14</small></p></header><aside><nav id=TableOfContents><ul><li><a href=#定义>定义</a></li><li><a href=#信号量的工作原理>信号量的工作原理</a></li><li><a href=#二元信号量>二元信号量</a></li><li><a href=#进程如何获得共享资源>进程如何获得共享资源</a></li><li><a href=#与信号量相关的函数>与信号量相关的函数</a></li><li><a href=#兼容系统v的信号量的函数>兼容系统v的信号量的函数</a><ul><li><a href=#semget>semget</a></li><li><a href=#semctl>semctl</a></li><li><a href=#semop>semop</a></li></ul></li><li><a href=#posix信号量函数>posix信号量函数</a><ul><li><a href=#sem_init>sem_init</a></li><li><a href=#sem_post>sem_post</a></li><li><a href=#sem_wait>sem_wait</a></li><li><a href=#sem_destroy>sem_destroy</a></li></ul></li><li><a href=#例子>例子</a></li></ul></nav></aside><h2 id=定义>定义</h2><p>信号量本质上是一个计数器（不设置全局变量是因为进程间是相互独立的，而这不一定能看到，看到也不能保证<code>++</code>引用计数为原子操作）,用于多进程对共享数据对象的读取，它和管道有所不同，它不以传送数据为主要目的，它主要是用来保护共享资源（信号量也属于临界资源），使得资源在一个时刻只有一个进程独享。</p><h2 id=信号量的工作原理>信号量的工作原理</h2><p>由于信号量只能进行两种操作等待和发送信号，即<code>P(sv)</code>和<code>V(sv)</code>edg,他们的行为是这样的：</p><ol><li>P(sv)：如果sv的值大于零，就给它减1；如果它的值为零，就挂起该进程的执行</li><li>V(sv)：如果有其他进程因等待sv而被挂起，就让它恢复运行，如果没有进程因等待sv而挂起，就给它加1.</li></ol><p>在信号量进行PV操作时都为原子操作（因为它需要保护临界资源）</p><p>注：原子操作：单指令的操作称为原子的，单条指令的执行是不会被打断的</p><h2 id=二元信号量>二元信号量</h2><p>二元信号量（Binary Semaphore）是最简单的一种锁（互斥锁），它只用两种状态：占用与非占用。所以它的引用计数为1。</p><h2 id=进程如何获得共享资源>进程如何获得共享资源</h2><ol><li>测试控制该资源的信号量</li><li>信号量的值为正，进程获得该资源的使用权，进程将信号量减1，表示它使用了一个资源单位</li><li>若此时信号量的值为0，则进程进入挂起状态（进程状态改变），直到信号量的值大于0，若进程被唤醒则返回至第一步。</li></ol><p>注：信号量通过同步与互斥保证访问资源的一致性。</p><h2 id=与信号量相关的函数>与信号量相关的函数</h2><ul><li>sem_init 是posix信号量，进程退出会自动释放</li><li>semget 是兼容系统v的信号量，必须明确对其进行删除操作才会释放</li></ul><p>通常使用posix信号量函数比较多</p><h2 id=兼容系统v的信号量的函数>兼容系统v的信号量的函数</h2><h3 id=semget>semget</h3><p>创建信号量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/sem.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>semget</span><span class=p>(</span><span class=n>key_t</span> <span class=n>key</span><span class=p>,</span> <span class=kt>int</span> <span class=n>nsems</span><span class=p>,</span> <span class=kt>int</span> <span class=n>semflg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define key_t int
</span></span></span></code></pre></div><p>参数:</p><ul><li>key: 建立IPC通讯(消息队列，信号量和共享内存)时必须指定一个ID值。通常情况下，该id值通过ftok函数得到，由内核变成标识符，要想让两个进程看到同一个信号集，只需设置key值不变就可以。</li><li>nsems: 指定信号量集中需要大的信号量数目，通常为1</li><li>semflg: 一组标志，当想要当信号量不存在时创建一个新的信号量，可以将flag设置为IPC_CREAT与文件权限按位或操作<blockquote><p>设置了IPC_CREAT标志后，即使给出的key是一个已有信号量的key，也不会产生错误。而IPC_CREAT | IPC_EXCL则可以创建一个新的，唯一的信号量，如果信号量已存在，返回一个错误。一般我们会还或上一个文件权限</p></blockquote></li></ul><h3 id=semctl>semctl</h3><p>删除和初始化信号量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/sem.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>semctl</span><span class=p>(</span><span class=kt>int</span> <span class=n>semid</span><span class=p>,</span> <span class=kt>int</span> <span class=n>semnum</span><span class=p>,</span> <span class=kt>int</span> <span class=n>cmd</span><span class=p>,</span> <span class=p>...);</span>
</span></span></code></pre></div><p>参数:</p><ul><li><p>semid: 由<code>semget</code>返回的信号量标识符</p></li><li><p>semnum: 当前信号量集的哪一个信号量</p></li><li><p>cmd: 通常下面两个值中大的其中一个</p><ul><li>SETVAL: 用来把信号量初始化为一个已知的值。p 这个值通过union semun中的val成员设置，其作用是在信号量第一次使用前对它进行设置。</li><li>IPC_RMID: 用于删除一个已经无需继续使用的信号量标识符，删除的话就不需要缺省参数，只需要三个参数即可</li></ul><p>如有需要第四个参数一般设置为union semnu arg</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>union</span> <span class=n>semun</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span>              <span class=n>val</span><span class=p>;</span>    <span class=cm>/* Value for SETVAL */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>semid_ds</span> <span class=o>*</span><span class=n>buf</span><span class=p>;</span>    <span class=cm>/* Buffer for IPC_STAT, IPC_SET */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>short</span>  <span class=o>*</span><span class=n>array</span><span class=p>;</span>  <span class=cm>/* Array for GETALL, SETALL */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>seminfo</span>  <span class=o>*</span><span class=n>__buf</span><span class=p>;</span>  <span class=cm>/* Buffer for IPC_INFO
</span></span></span><span class=line><span class=cl><span class=cm>                                (Linux-specific) */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div></li></ul><h3 id=semop>semop</h3><p>改变信号量大的值</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/sem.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>semop</span><span class=p>(</span><span class=kt>int</span> <span class=n>semid</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sembuf</span> <span class=o>*</span><span class=n>sops</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>nsops</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>semtimedop</span><span class=p>(</span><span class=kt>int</span> <span class=n>semid</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sembuf</span> <span class=o>*</span><span class=n>sops</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>nsops</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=k>const</span> <span class=k>struct</span> <span class=n>timespec</span> <span class=o>*</span><span class=n>timeout</span><span class=p>);</span>
</span></span></code></pre></div><p>参数:</p><ul><li>nsops: 进行操作信号量的个数，即sops结构变量的个数，需大于或等于1。最常见设置此值等于1，只完成对一个信号量的操作</li><li>sembuf:<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>sembuf</span><span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=kt>short</span> <span class=n>sem_num</span><span class=p>;</span>   <span class=c1>//除非使用一组信号量，否则它为0 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>short</span> <span class=n>sem_op</span><span class=p>;</span>   <span class=c1>//信号量在一次操作中需要改变的数据，通常是两个数，                                        
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>//一个是-1，即P（等待）操作， 
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>//一个是+1，即V（发送信号）操作。 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>short</span> <span class=n>sem_flg</span><span class=p>;</span> <span class=c1>//通常为SEM_UNDO,使操作系统跟踪信号量， 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>//并在进程没有释放该信号量而终止时，操作系统释放信号量 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span> 
</span></span></code></pre></div></li></ul><p>通常设置为SEM_UNDO,使操作系统跟踪信号量， 并在进程没有释放该信号量而终止时，操作系统释放信号量 ，例如在二元信号量中，你不释放该信号量 而异常退出，就会导致别的进程一直申请不到信号量，而一直处于挂起状态。</p><h2 id=posix信号量函数>posix信号量函数</h2><h3 id=sem_init>sem_init</h3><p>该函数用于创建信号量，其原型如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;semaphore.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sem_init</span><span class=p>(</span><span class=n>sem_t</span> <span class=o>*</span><span class=n>sem</span><span class=p>,</span> <span class=kt>int</span> <span class=n>pshared</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Link</span> <span class=n>with</span> <span class=o>-</span><span class=n>pthread</span><span class=p>.</span>
</span></span></code></pre></div><p>该函数初始化由sem指向的信号对象，设置它的共享选项，并给它一个初始的整数值。</p><ul><li>pshared: 控制信号量的类型，如果其值为0，就表示这个信号量是当前进程的局部信号量，否则信号量就可以在多个进程之间共享，</li><li>value: 为sem的初始值。</li></ul><p>返回值</p><ul><li>成功时返回0</li><li>失败返回-1.</li></ul><h3 id=sem_post>sem_post</h3><p>释放信号量，让信号量的值加1。相当于V操作。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;semaphore.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sem_post</span><span class=p>(</span><span class=n>sem_t</span> <span class=o>*</span><span class=n>sem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Link</span> <span class=n>with</span> <span class=o>-</span><span class=n>pthread</span><span class=p>.</span>
</span></span></code></pre></div><p>返回值:</p><ul><li>成功: 返回0</li><li>失败: 返回-1</li></ul><h3 id=sem_wait>sem_wait</h3><p>等待信号量，如果信号量的值大于0,将信号量的值减1,立即返回。如果信号量的值为0,则线程阻塞，相当于P操作。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sem_wait</span><span class=p>(</span><span class=n>sem_t</span> <span class=o>*</span><span class=n>sem</span><span class=p>);</span>  
</span></span></code></pre></div><p>成功返回0,失败返回-1。</p><h3 id=sem_destroy>sem_destroy</h3><p>该函数用于对用完的信号量的清理。它的原型如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>sem_destroy</span><span class=p>(</span><span class=n>sem_t</span> <span class=o>*</span><span class=n>sem</span><span class=p>);</span> 
</span></span></code></pre></div><p>成功时返回0，失败时返回-1.</p><h2 id=例子>例子</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;semaphore.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define total 20
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>sem_t</span> <span class=n>remain</span><span class=p>,</span> <span class=n>apple</span><span class=p>,</span> <span class=n>pear</span><span class=p>,</span> <span class=n>mutex</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>vremain</span> <span class=o>=</span> <span class=mi>20</span><span class=p>,</span> <span class=n>vapple</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>vpear</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>father</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>mather</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>son</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>daughter</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_sem</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=n>pthread_t</span> <span class=n>fa</span><span class=p>,</span> <span class=n>ma</span><span class=p>,</span> <span class=n>so</span><span class=p>,</span> <span class=n>da</span><span class=p>;</span>  
</span></span><span class=line><span class=cl>    <span class=n>sem_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>remain</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>total</span><span class=p>);</span><span class=c1>//总数初始化为20 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sem_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>apple</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span><span class=c1>//盆子中苹果数, 开始为0  
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sem_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pear</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span><span class=c1>//盆子中梨子数, 开始为0   
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sem_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span><span class=c1>//互斥锁, 初始为1 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fa</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>father</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ma</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mather</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>so</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>son</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    <span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>da</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>daughter</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>    
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(;;);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>father</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>      
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>remain</span><span class=p>);</span>     
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>      
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;父亲: 放苹果之前, 剩余空间=%u, 苹果数=%u</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>vremain</span><span class=o>--</span><span class=p>,</span> <span class=n>vapple</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;父亲: 放苹果之后, 剩余空间=%u, 苹果数=%u</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>vremain</span><span class=p>,</span> <span class=n>vapple</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>      
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>apple</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>mather</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>      
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>remain</span><span class=p>);</span>     
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>      
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;母亲: 放梨子之前, 剩余空间=%u, 梨子数=%u</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>vremain</span><span class=o>--</span><span class=p>,</span> <span class=n>vpear</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;母亲: 放梨子之后, 剩余空间=%u, 梨子数=%u</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>vremain</span><span class=p>,</span> <span class=n>vpear</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pear</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>son</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>      
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pear</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;儿子: 吃梨子之前, 剩余空间=%u, 梨子数=%u</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>vremain</span><span class=o>++</span><span class=p>,</span> <span class=n>vpear</span><span class=o>--</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;儿子: 吃梨子之后, 剩余空间=%u, 梨子数=%u</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>vremain</span><span class=p>,</span> <span class=n>vpear</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>remain</span><span class=p>);</span>     
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>daughter</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>  
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>apple</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>sem_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;女儿: 吃苹果之前, 剩余空间=%u, 苹果数=%u</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>vremain</span><span class=o>++</span><span class=p>,</span> <span class=n>vapple</span><span class=o>--</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;女儿: 吃苹果之前, 剩余空间=%u, 苹果数=%u</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>vremain</span><span class=p>,</span> <span class=n>vapple</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>        <span class=n>sem_post</span><span class=p>(</span><span class=o>&amp;</span><span class=n>remain</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_sem</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>  
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>val1</span><span class=p>,</span> <span class=n>val2</span><span class=p>,</span> <span class=n>val3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sem_getvalue</span><span class=p>(</span><span class=o>&amp;</span><span class=n>remain</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>val1</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>sem_getvalue</span><span class=p>(</span><span class=o>&amp;</span><span class=n>apple</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>val2</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>    <span class=n>sem_getvalue</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pear</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>val3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Semaphore: remain:%d, apple:%d, pear:%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>val1</span><span class=p>,</span> <span class=n>val2</span><span class=p>,</span> <span class=n>val3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>运行结果</p><pre tabindex=0><code>母亲: 放梨子之前, 剩余空间=20, 梨子数=0
母亲: 放梨子之后, 剩余空间=19, 梨子数=1
儿子: 吃梨子之前, 剩余空间=19, 梨子数=1
儿子: 吃梨子之后, 剩余空间=20, 梨子数=0
父亲: 放苹果之前, 剩余空间=20, 苹果数=0
父亲: 放苹果之后, 剩余空间=19, 苹果数=1
女儿: 吃苹果之前, 剩余空间=19, 苹果数=1
女儿: 吃苹果之前, 剩余空间=20, 苹果数=0
父亲: 放苹果之前, 剩余空间=20, 苹果数=0
父亲: 放苹果之后, 剩余空间=19, 苹果数=1
母亲: 放梨子之前, 剩余空间=19, 梨子数=0
母亲: 放梨子之后, 剩余空间=18, 梨子数=1
父亲: 放苹果之前, 剩余空间=18, 苹果数=1
父亲: 放苹果之后, 剩余空间=17, 苹果数=2
儿子: 吃梨子之前, 剩余空间=17, 梨子数=1
儿子: 吃梨子之后, 剩余空间=18, 梨子数=0
女儿: 吃苹果之前, 剩余空间=18, 苹果数=2
女儿: 吃苹果之前, 剩余空间=19, 苹果数=1
父亲: 放苹果之前, 剩余空间=19, 苹果数=1
父亲: 放苹果之后, 剩余空间=18, 苹果数=2
母亲: 放梨子之前, 剩余空间=18, 梨子数=0
母亲: 放梨子之后, 剩余空间=17, 梨子数=1
父亲: 放苹果之前, 剩余空间=17, 苹果数=2
父亲: 放苹果之后, 剩余空间=16, 苹果数=3
父亲: 放苹果之前, 剩余空间=16, 苹果数=3
父亲: 放苹果之后, 剩余空间=15, 苹果数=4
儿子: 吃梨子之前, 剩余空间=15, 梨子数=1
儿子: 吃梨子之后, 剩余空间=16, 梨子数=0
女儿: 吃苹果之前, 剩余空间=16, 苹果数=4
女儿: 吃苹果之前, 剩余空间=17, 苹果数=3
母亲: 放梨子之前, 剩余空间=17, 梨子数=0
母亲: 放梨子之后, 剩余空间=16, 梨子数=1
父亲: 放苹果之前, 剩余空间=16, 苹果数=3
父亲: 放苹果之后, 剩余空间=15, 苹果数=4
父亲: 放苹果之前, 剩余空间=15, 苹果数=4
父亲: 放苹果之后, 剩余空间=14, 苹果数=5
</code></pre><p>原文:https://www.cnblogs.com/wuyepeng/p/9748552.html</p></article></div></body><div><small>words: 3280 tags:</small>
<small><code><a href=https://arair.net/tags/linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1>linux进程间通信</a></code></small></div></html></body><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?bd28dafb59c7621d0ab721cefd01691b",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script id=LA_COLLECT src=//sdk.51.la/js-sdk-pro.min.js></script>
<script>LA.init({id:"JMTlKgP6j8mqnJSa",ck:"JMTlKgP6j8mqnJSa"})</script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.2.0/build/styles/default.min.css><script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.2.0/build/highlight.min.js></script>
<script>hljs.highlightAll()</script></html>