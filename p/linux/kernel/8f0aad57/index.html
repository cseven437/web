<!doctype html><html><title>内核初始化</title><meta name=description content="引导期间的内核选项 linux允许用户把内核配置选项传给引导记录，然后引导记录再把选项传给内核。
parse_args函数用于解析输入字符串，输入的字符串内是一些参数，其形式为变量名称=值，寻找关键字，并开启适当的处理函数。加载模块时，也会用到parse_args，借以解析命令列参数。
函数位置kernel/params.c
"><meta name=generator content="Hugo 0.93.3">
<meta property="og:title" content="内核初始化">
<meta property="og:description" content="引导期间的内核选项
linux允许用户把内核配置选项传给引导记录，然后引导记录再把选项传给内核。
parse_args函数用于解析输入字符串，输入的字符串内是一些参数，其形式为变量名称=值，寻找关键字，并开启适当的处理函数。加载模块时，也会用到parse_args，借以解析命令列参数。
函数位置kernel/params.c">
<meta property="og:type" content="article">
<meta property="og:url" content="https://arair.net/p/linux/kernel/8f0aad57/"><meta property="article:section" content="p">
<meta property="article:published_time" content="2021-01-24T11:45:03+08:00">
<meta property="article:modified_time" content="2021-09-12T18:05:24+08:00">
<meta itemprop=name content="内核初始化">
<meta itemprop=description content="引导期间的内核选项
linux允许用户把内核配置选项传给引导记录，然后引导记录再把选项传给内核。
parse_args函数用于解析输入字符串，输入的字符串内是一些参数，其形式为变量名称=值，寻找关键字，并开启适当的处理函数。加载模块时，也会用到parse_args，借以解析命令列参数。
函数位置kernel/params.c"><meta itemprop=datePublished content="2021-01-24T11:45:03+08:00">
<meta itemprop=dateModified content="2021-09-12T18:05:24+08:00">
<meta itemprop=wordCount content="890">
<meta itemprop=keywords content>
<style type=text/css>.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media(max-width:767px){.markdown-body{padding:15px}}</style><script>function setTheme({el:e=document.documentElement,mode:t="auto",light:n="light",dark:s="dark"}){e.dataset.colorMode=t,e.dataset.lightTheme=n,e.dataset.darkTheme=s}let prefersDarkMode=window.matchMedia("(prefers-color-scheme: dark)").matches;prefersDarkMode&&setTheme({mode:"dark"})</script>
<link rel=stylesheet href=/style.css type=text/css><body id=content class=markdown-body>
<body>
<div id=post class=post>
<article>
<header>
<h1 class=post-title>内核初始化</h1><p>
<small>
2021-01-24, updated 2021-09-12
</small>
</p></header><aside>
<nav id=TableOfContents>
<ul>
<li><a href=#注册关键字>注册关键字</a></li><li><a href=#使用引导选项配置网络设备>使用引导选项配置网络设备</a></li></ul></nav></aside><h1 id=引导期间的内核选项>引导期间的内核选项</h1><p>linux允许用户把内核配置选项传给引导记录，然后引导记录再把选项传给内核。</p><p>parse_args函数用于解析输入字符串，输入的字符串内是一些参数，其形式为<code>变量名称=值</code>，寻找关键字，并开启适当的处理函数。加载模块时，也会用到parse_args，借以解析命令列参数。</p><p>函数位置<code>kernel/params.c</code></p><h2 id=注册关键字>注册关键字</h2><p>内核组件可以利用在<code>include/linux/init.h</code>中的<code>__setup</code>宏，注册关键字和相关联的处理函数。</p><pre tabindex=0><code>__setup(str, func)
</code></pre><ul>
<li>string: 关键字</li><li>func: 相关联的处理函数</li></ul><p>注意事项：string必须以<code>=</code>字符作结束，以使<code>parse_args</code>的解析能轻松一点。任何跟在<code>=</code>之后的文本都将作为输入值传给function_handler。</p><p>例子</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>__setup</span><span class=p>(</span><span class=s>&#34;netdev=&#34;</span><span class=p>,</span> <span class=n>netdev_boot_setup</span><span class=p>);</span>
</span></span></code></pre></div><p>其中<code>net_dev_boot_setup</code>注册成了<code>netdev=</code>关键字的处理函数。</p><p>同一个处理函数可以与几个不同关键字相关联。</p><p>当代码编译成模块时，<code>__setup</code>宏会被忽略(即定义位空)详情可查看<code>include/linux/init.h</code></p><h2 id=使用引导选项配置网络设备>使用引导选项配置网络设备</h2><p>相关结构体</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * This structure holds at boot time configured netdevice settings. They
</span></span></span><span class=line><span class=cl><span class=cm> * are then used in the device probing.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>netdev_boot_setup</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=n>IFNAMSIZ</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>ifmap</span> <span class=n>map</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*   
</span></span></span><span class=line><span class=cl><span class=cm> *  Device mapping structure. I&#39;d just gone off and designed a 
</span></span></span><span class=line><span class=cl><span class=cm> *  beautiful scheme using only loadable modules with arguments
</span></span></span><span class=line><span class=cl><span class=cm> *  for driver options and along come the PCMCIA people 8)
</span></span></span><span class=line><span class=cl><span class=cm> *   
</span></span></span><span class=line><span class=cl><span class=cm> *  Ah well. The get() side of this is good for WDSETUP, and it&#39;ll
</span></span></span><span class=line><span class=cl><span class=cm> *  be handy for debugging things. The set side is fine for now and
</span></span></span><span class=line><span class=cl><span class=cm> *  being very small might be worth keeping for clean configuration.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* for compatibility with glibc net/if.h */</span>
</span></span><span class=line><span class=cl><span class=cp>#if __UAPI_DEF_IF_IFMAP
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>struct</span> <span class=n>ifmap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>mem_start</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>mem_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>base_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>irq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>dma</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 3 bytes spare */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=cp>#endif </span><span class=cm>/* __UAPI_DEF_IF_IFMAP */</span><span class=cp>
</span></span></span></code></pre></div><p>网络设备初始化时，会调用关键字<code>netdev=</code>注册的处理函数<code>netdev_boot_setup</code>，将netdev对应的值写到dev_boot_setup对应结构体中的name。</p><p>以下为调用流程</p><p><code>net/core/dev.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define NETDEV_BOOT_SETUP_MAX 8
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Boot time configuration table */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>netdev_boot_setup</span> <span class=n>dev_boot_setup</span><span class=p>[</span><span class=n>NETDEV_BOOT_SETUP_MAX</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>__setup</span><span class=p>(</span><span class=s>&#34;netdev=&#34;</span><span class=p>,</span> <span class=n>netdev_boot_setup</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Saves at boot time configured settings for any netdevice.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>__init</span> <span class=nf>netdev_boot_setup</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ints</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>ifmap</span> <span class=n>map</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>str</span> <span class=o>=</span> <span class=n>get_options</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=n>ARRAY_SIZE</span><span class=p>(</span><span class=n>ints</span><span class=p>),</span> <span class=n>ints</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>str</span> <span class=o>||</span> <span class=o>!*</span><span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Save settings */</span>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>map</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>map</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ints</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>map</span><span class=p>.</span><span class=n>irq</span> <span class=o>=</span> <span class=n>ints</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ints</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>map</span><span class=p>.</span><span class=n>base_addr</span> <span class=o>=</span> <span class=n>ints</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ints</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>map</span><span class=p>.</span><span class=n>mem_start</span> <span class=o>=</span> <span class=n>ints</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ints</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>map</span><span class=p>.</span><span class=n>mem_end</span> <span class=o>=</span> <span class=n>ints</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Add new entry to the list */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>netdev_boot_setup_add</span><span class=p>(</span><span class=n>str</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>map</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> *  netdev_boot_setup_add   - add new setup entry
</span></span></span><span class=line><span class=cl><span class=cm> *  @name: name of the device
</span></span></span><span class=line><span class=cl><span class=cm> *  @map: configured settings for the device
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> *  Adds new setup entry to the dev_boot_setup list.  The function
</span></span></span><span class=line><span class=cl><span class=cm> *  returns 0 on error and 1 on success.  This is a generic routine to
</span></span></span><span class=line><span class=cl><span class=cm> *  all netdevices.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>netdev_boot_setup_add</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>,</span> <span class=k>struct</span> <span class=n>ifmap</span> <span class=o>*</span><span class=n>map</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>netdev_boot_setup</span> <span class=o>*</span><span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>dev_boot_setup</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NETDEV_BOOT_SETUP_MAX</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>name</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;\0&#39;</span> <span class=o>||</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>name</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39; &#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>memset</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>name</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>strlcpy</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>name</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>IFNAMSIZ</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>memcpy</span><span class=p>(</span><span class=o>&amp;</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>map</span><span class=p>,</span> <span class=n>map</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>map</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>NETDEV_BOOT_SETUP_MAX</span> <span class=o>?</span> <span class=mi>0</span> <span class=o>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></article></div></body><div>
<small> words: 890 tags:</small>
</div></html></body><script>var _hmt=_hmt||[];(function(){var e=document.createElement("script"),t;e.src="https://hm.baidu.com/hm.js?bd28dafb59c7621d0ab721cefd01691b",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script>
<script id=LA_COLLECT src=//sdk.51.la/js-sdk-pro.min.js></script>
<script>LA.init({id:"JMTlKgP6j8mqnJSa",ck:"JMTlKgP6j8mqnJSa"})</script>
<link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.2.0/build/styles/default.min.css>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.2.0/build/highlight.min.js></script>
<script>hljs.highlightAll()</script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>window.onload=function(){mermaid.initialize({theme:"default"}),mermaid.init(void 0,".language-mermaid")}</script>
</html>